# Full Flake Structure

A complete flake using all Imp features: registry, config trees, collect inputs, and visualization.

## Directory Layout

```
my-flake/
  flake.nix                    # Auto-generated
  nix/
    flake/
      default.nix              # Flake entry point
      inputs.nix               # Core inputs
    outputs/
      nixosConfigurations/
        server.nix
        workstation.nix
      homeConfigurations/
        alice@workstation.nix
      perSystem/
        packages.nix
        devShells.nix
        formatter.nix          # Uses __inputs
        checks.nix
      overlays.nix
    registry/
      hosts/
        server/
          default.nix
          hardware.nix
          config/
            networking.nix
            boot.nix
        workstation/
          default.nix
          hardware.nix
          config/
            ...
      modules/
        nixos/
          base.nix
          features/
            networking.nix
            ssh.nix
            desktop.nix
        home/
          base.nix
          features/
            shell/
              default.nix
              programs/...
            devTools/
              programs/...
      users/
        alice/
          default.nix
          programs/
            git.nix
            zsh.nix
```

## flake.nix (Auto-generated)

```nix
# Auto-generated by imp - run `nix run .#imp-flake` to update
{
  inputs = {
    # Core inputs
    nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
    flake-parts.url = "github:hercules-ci/flake-parts";
    imp.url = "github:Alb-O/imp";
    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    
    # Collected from __inputs
    treefmt-nix.url = "github:numtide/treefmt-nix";
  };

  outputs = inputs: import ./nix/flake inputs;
}
```

## nix/flake/inputs.nix

```nix
# Core inputs - always in flake.nix
{
  nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
  flake-parts.url = "github:hercules-ci/flake-parts";
  imp.url = "github:Alb-O/imp";
  home-manager = {
    url = "github:nix-community/home-manager";
    inputs.nixpkgs.follows = "nixpkgs";
  };
}
```

## nix/flake/default.nix

```nix
inputs:
let
  inherit (inputs) flake-parts;
in
flake-parts.lib.mkFlake { inherit inputs; } {
  imports = [ inputs.imp.flakeModules.default ];

  systems = [ "x86_64-linux" "aarch64-linux" ];

  imp = {
    src = ../outputs;
    registry.src = ../registry;
    registry.migratePaths = [ ../outputs ../registry ];
    
    flakeFile = {
      enable = true;
      coreInputs = import ./inputs.nix;
      outputsFile = "./nix/flake";
    };
  };
}
```

## nix/outputs/perSystem/formatter.nix

```nix
# Uses inline __inputs - collected into flake.nix
{
  __inputs.treefmt-nix.url = "github:numtide/treefmt-nix";

  __functor = _: { pkgs, inputs, ... }:
    inputs.treefmt-nix.lib.evalModule pkgs {
      projectRootFile = "flake.nix";
      programs.nixfmt.enable = true;
    };
}
```

## nix/outputs/perSystem/devShells.nix

```nix
{ pkgs, inputs, ... }:
{
  default = pkgs.mkShell {
    packages = with pkgs; [
      nil
      nixfmt-rfc-style
    ];
  };
}
```

## nix/outputs/nixosConfigurations/server.nix

```nix
{ lib, inputs, imp, registry, ... }:
lib.nixosSystem {
  system = "x86_64-linux";
  specialArgs = { inherit inputs imp registry; };
  modules = imp.imports [
    registry.hosts.server
    registry.modules.nixos.base
    registry.modules.nixos.features.ssh
  ];
}
```

## nix/outputs/homeConfigurations/alice@workstation.nix

```nix
{ inputs, nixpkgs, imp, registry, ... }:
inputs.home-manager.lib.homeManagerConfiguration {
  pkgs = nixpkgs.legacyPackages.x86_64-linux;
  extraSpecialArgs = { inherit inputs imp registry; };
  modules = [ (import registry.users.alice) ];
}
```

## nix/registry/hosts/server/default.nix

```nix
{ inputs, imp, registry, ... }:
{
  imports = [
    ./hardware.nix
    (imp.configTree ./config)
    inputs.home-manager.nixosModules.home-manager
  ];

  home-manager = {
    useGlobalPkgs = true;
    useUserPackages = true;
    extraSpecialArgs = { inherit inputs imp registry; };
    users.alice = import registry.users.alice;
  };
}
```

## nix/registry/users/alice/default.nix

```nix
{ imp, registry, ... }:
{
  imports = [
    registry.modules.home.features.shell
    registry.modules.home.features.devTools
    (imp.configTree ./.)
  ];
  
  home.username = "alice";
  home.homeDirectory = "/home/alice";
  home.stateVersion = "24.05";
}
```

## Commands

```sh
# Build NixOS configuration
nixos-rebuild build --flake .#server

# Build Home Manager configuration  
home-manager build --flake .#alice@workstation

# Regenerate flake.nix with collected inputs
nix run .#imp-flake

# Check for broken registry references after renames
nix run .#imp-registry

# Generate dependency visualization
nix run .#imp-vis > deps.html

# Run all checks
nix flake check

# Format code
nix fmt
```

## See Also

- [Getting Started](../getting-started.md) - Basic setup
- [Using with flake-parts](../guides/flake-parts.md) - flake-parts integration
- [The Registry](../concepts/registry.md) - Registry overview
- [Collect Inputs](../guides/collect-inputs.md) - Inline input declaration
