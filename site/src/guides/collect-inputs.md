# Collect Inputs

Declare flake inputs inline where they're used, rather than in a central `flake.nix`.

## The Problem

Traditional flake inputs are declared far from where they're used:

```nix
# flake.nix
{
  inputs = {
    nixpkgs.url = "...";
    treefmt-nix.url = "github:numtide/treefmt-nix";  # Only used in one file
    # ... 20 more inputs
  };
}

# outputs/perSystem/formatter.nix (far away)
{ inputs, pkgs, ... }:
inputs.treefmt-nix.lib.evalModule pkgs { /* ... */ }
```

## The Solution

Declare inputs where they're used with `__inputs`:

```nix
# outputs/perSystem/formatter.nix
{
  __inputs.treefmt-nix.url = "github:numtide/treefmt-nix";

  __functor = _: { pkgs, inputs, ... }:
    inputs.treefmt-nix.lib.evalModule pkgs {
      projectRootFile = "flake.nix";
      programs.nixfmt.enable = true;
    };
}
```

## How It Works

1. Imp scans your outputs directory for `__inputs` declarations
2. Collects all inputs into a merged set
3. Generates or updates `flake.nix` with the collected inputs

## Setup

Enable flake file generation:

```nix
# nix/flake/default.nix
inputs:
flake-parts.lib.mkFlake { inherit inputs; } {
  imports = [ inputs.imp.flakeModules.default ];

  imp = {
    src = ../outputs;
    flakeFile = {
      enable = true;
      coreInputs = import ./inputs.nix;
      outputsFile = "./nix/flake";
    };
  };
}
```

Create core inputs (always included):

```nix
# nix/flake/inputs.nix
{
  nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
  flake-parts.url = "github:hercules-ci/flake-parts";
  imp.url = "github:Alb-O/imp";
}
```

## Regenerating flake.nix

After adding/changing `__inputs`:

```sh
nix run .#imp-flake
```

This updates `flake.nix` with all collected inputs.

## File Format

Files with `__inputs` must use `__functor` pattern:

```nix
{
  # Declare needed inputs
  __inputs = {
    treefmt-nix.url = "github:numtide/treefmt-nix";
    # Can include follows
    treefmt-nix.inputs.nixpkgs.follows = "nixpkgs";
  };

  # __functor makes this callable
  __functor = _: { pkgs, inputs, ... }:
    # Your actual output
    inputs.treefmt-nix.lib.evalModule pkgs { /* ... */ };
}
```

## Core vs Inline Inputs

**Core inputs** (`coreInputs`):
- Always in `flake.nix`
- Used across multiple files
- Examples: `nixpkgs`, `flake-parts`, `home-manager`

**Inline inputs** (`__inputs`):
- Declared where used
- Collected into `flake.nix` automatically
- Examples: `treefmt-nix`, `nix-unit`

## Conflict Detection

If two files declare the same input with different URLs, Imp errors:

```nix
# file-a.nix
{ __inputs.foo.url = "github:owner/foo"; /* ... */ }

# file-b.nix
{ __inputs.foo.url = "github:other/foo"; /* ... */ }  # Error!
```

Fix by moving shared inputs to `coreInputs`.

## Example Generated flake.nix

```nix
# Auto-generated by imp
{
  inputs = {
    # Core inputs
    nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
    flake-parts.url = "github:hercules-ci/flake-parts";
    imp.url = "github:Alb-O/imp";
    
    # Collected from __inputs
    treefmt-nix.url = "github:numtide/treefmt-nix";
    treefmt-nix.inputs.nixpkgs.follows = "nixpkgs";
  };

  outputs = inputs: import ./nix/flake inputs;
}
```

## When to Use

**Use inline `__inputs` for:**
- Single-use inputs
- Optional features
- Keeping related code together

**Use `coreInputs` for:**
- Widely used inputs (`nixpkgs`, `home-manager`)
- Inputs that need `follows` from other cores
- Foundational dependencies

## See Also

- [Using with flake-parts](./flake-parts.md) - Integration setup
- [Module Options](../reference/options.md) - All flakeFile options
